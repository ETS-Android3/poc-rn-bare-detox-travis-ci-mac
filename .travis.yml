language: node_js
node_js: lts/*
git:
  quiet: true
env:
  global:
    - ANDROID_API=28
    - NODE_VERSION=lts/*
branches:
  only:
    - master
    - develop
jobs:
  include:
  - name: Unit tests
    cache:
      directories:
        - "$HOME/.npm"
    install:
      - npm install -g react-native-cli
      - npm install -g detox-cli
      - npm install
    script: npm run test:unit
  - name: Integration iOS tests
    os: osx
    osx_image: xcode11.3
    language: objective-c
    cache:
      cocoapods: true
    podfile: "./ios/Podfile"
    install:
      - brew tap wix/brew
      - brew install applesimutils
      - npm install -g react-native-cli
      - npm install -g detox-cli
      - npm install
    script:
      - npm run ios:pod:install
      - npm run detox:ios:release:build > /dev/null
      - npm run detox:ios:release:test
  - name: Integration Android tests
    language: android
    before_cache:
      - rm -f  $HOME/.gradle/caches/modules-2/modules-2.lock
      - rm -fr $HOME/.gradle/caches/*/plugin-resolution/
    cache:
      directories:
        - $HOME/.gradle/caches/
        - $HOME/.gradle/wrapper/
        - $HOME/.android/build-cache
    jdk: openjdk8
    dist: trusty
    sudo: required
    android:
      components:
        - tools
        - platform-tools
        - build-tools-28.0.3
        - android-${ANDROID_API}
        - sys-img-x86-google_apis-28
        - sys-img-armeabi-v7a-android-28
        - extra-android-m2repository
    install:
      - curl -o- https://raw.githubusercontent.com/creationix/nvm/v0.33.2/install.sh | bash
      - export NVM_DIR="$HOME/.nvm" && [ -s "$NVM_DIR/nvm.sh" ] && . "$NVM_DIR/nvm.sh"
      - nvm install $NODE_VERSION
      - nvm use $NODE_VERSION
      - nvm alias default $NODE_VERSION

      - npm install -g react-native-cli
      - npm install -g detox-cli
      - npm install
    before_script:
      - openssl aes-256-cbc -K $encrypted_b6e934f6223e_key -iv $encrypted_b6e934f6223e_iv -in android/RNDetoxTravisTest.keystore.enc -out android/RNDetoxTravisTest.keystore -d
      - sdkmanager --list
      - android list avds
      - android list targets
      # - echo no | avdmanager create avd --force --name pixel_xl --device "pixel_xl" -k 'system-images;android-28;google_apis;x86'
      # Create Android Emulator
      - echo no | android create avd --force --name pixel_xl -t android-28 --abi google_apis/x86
      - android list avds
      # Start Android Emulator
      - emulator -avd pixel_xl -no-skin -no-audio -no-window &
      - android-wait-for-emulator
      - adb shell input keyevent 82 &
    script:
      - npm run detox:android:release:build
      - npx detox test --headless -c android.emu.release --gpu swiftshader --cleanup
